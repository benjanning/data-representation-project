<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Cars</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>

<body>
    <h1>CARS</h1>
    <div> <button id="showCreateButton" class="btn btn-success">Create</button></div>
    <div>
        <table class="table table-striped table-dark table-bordered table-hover" id="carTable">
            <thead>
                <tr>
                    <th scope="col">id</th>
                    <th scope="col">Reg</th>
                    <th scope="col">Model</th>
                    <th scope="col">Price</th>
                    <th scope="col">Update</th>
                    <th scope="col">Delete</th>
                </tr>
            </thead>
            <tbody>
                <!-- Table rows will be added here -->
            </tbody>
        </table>
    </div>
    <div id='createUpdateForm' style="display: none">
        <h2><span id="createLabel">Create a</span><span id="updateLabel" style="display: none;">Update</span> CAR</h2>
        <input type="hidden" name="id"/>
        Reg <input type="text" name="Reg" /><br/>
        Model <input type="text" name="Model"/> <br/>
        Price <input type="number" name="Price"/> <br/>
        <button id="doCreateButton" class="btn btn-primary">Create</button>
        <button id="doUpdateButton" class="btn btn-warning" style="display: none;">Update</button>
    </div>

    <script>
        $(document).ready(function(){
            // Event handlers for the showCreate and doCreate buttons
            $("#showCreateButton").on("click", showCreate);
            $("#doCreateButton").on("click", doCreate);
            $("#doUpdateButton").on("click", doUpdate);

            // Fetch all cars on page load
            getAllAjax();

            // Event delegation for dynamically created update and delete buttons
            $(document).on("click", ".updateButton", function(){
                showUpdate(this);
            });
            $(document).on("click", ".deleteButton", function(){
                doDelete(this);
            });

            function showCreate(){
                $("#showCreateButton, #carTable").hide();
                $("#createUpdateForm").show();
                $("#createLabel").show();
                $("#updateLabel").hide();
                $("#doCreateButton").show();
                $("#doUpdateButton").hide();
                clearForm();
            }

            function showViewAll(){
                $("#showCreateButton, #carTable").show();
                $("#createUpdateForm").hide();
            }

            function showUpdate(buttonElement){
                $("#showCreateButton, #carTable").hide();
                $("#createUpdateForm").show();
                $("#createLabel").hide();
                $("#updateLabel").show();
                $("#doCreateButton").hide();
                $("#doUpdateButton").show();

                var rowElement = $(buttonElement).closest("tr");
                var car = getCarFromRow(rowElement);
                populateFormWithCar(car);
            }

            function doCreate(){
                var car = getCarFromForm();
                createCarAjax(car);
            }

            function doUpdate(){
                var car = getCarFromForm();
                updateCarAjax(car);
            }

            function doDelete(buttonElement){
                var rowElement = $(buttonElement).closest("tr");
                var carId = rowElement.data("id");
                deleteCarAjax(carId);
            }

            function addCarToTable(car){
                var rowElement = $("<tr>").data("id", car.id);
                $("<td>").text(car.id).appendTo(rowElement);
                $("<td>").text(car.Reg).appendTo(rowElement);
                $("<td>").text(car.Model).appendTo(rowElement);
                $("<td>").text(car.Price).appendTo(rowElement);
                $("<td>").html('<button class="updateButton btn btn-primary">Update</button>').appendTo(rowElement);
                $("<td>").html('<button class="deleteButton btn btn-danger">Delete</button>').appendTo(rowElement);
                $("#carTable tbody").append(rowElement);
            }

            function clearForm(){
                $("#createUpdateForm").find('input[type="text"], input[type="number"]').val('');
            }

            function getCarFromRow(rowElement){
                return {
                    id: rowElement.data('id'),
                    Reg: rowElement.find('td:eq(1)').text(),
                    Model: rowElement.find('td:eq(2)').text(),
                    Price: parseInt(rowElement.find('td:eq(3)').text(), 10)
                };
            }

            function setCarInRow(car){
                var rowElement = $("#carTable tbody").find('tr').filter(function() {
                    return $(this).data("id") === car.id;
                });
                rowElement.find('td:eq(0)').text(car.id);
                rowElement.find('td:eq(1)').text(car.Reg);
                rowElement.find('td:eq(2)').text(car.Model);
                rowElement.find('td:eq(3)').text(car.Price);
            }

            function populateFormWithCar(car){
                var form = $("#createUpdateForm");
                form.find('input[name="id"]').val(car.id);
                form.find('input[name="Reg"]').val(car.Reg);
                form.find('input[name="Model"]').val(car.Model);
                form.find('input[name="Price"]').val(car.Price);
            }

            function getCarFromForm(){
                var form = $("#createUpdateForm");
                return {
                    id: form.find('input[name="id"]').val(),
                    Reg: form.find('input[name="Reg"]').val(),
                    Model: form.find('input[name="Model"]').val(),
                    Price: parseInt(form.find('input[name="Price"]').val(), 10)
                };
            }

            function getAllAjax(){
                $.ajax({
                    url: "http://127.0.0.1:5000/cars",
                    method: "GET",
                    dataType: "JSON",
                    success: function(result){
                        result.forEach(function(car) {
                            addCarToTable(car);
                        });
                    },
                    error: function(xhr, status, error){
                        alert("An error occurred while fetching cars: " + status + " " + error);
                    }
                });
            }

            function createCarAjax(car){
                $.ajax({
                    url: "http://127.0.0.1:5000/cars",
                    method: "POST",
                    data: JSON.stringify(car),
                    contentType: "application/json; charset=utf-8",
                    dataType: "JSON",
                    success: function(result){
                        addCarToTable(result);
                        clearForm();
                        showViewAll();
                    },
                    error: function(xhr, status, error){
                        alert("An error occurred while creating car: " + status + " " + error);
                    }
                });
            }

            function updateCarAjax(car){
                $.ajax({
                    url: "http://127.0.0.1:5000/cars/" + encodeURIComponent(car.id),
                    method: "PUT",
                    data: JSON.stringify(car),
                    contentType: "application/json; charset=utf-8",
                    dataType: "JSON",
                    success: function(result){
                        setCarInRow(result);
                        clearForm();
                        showViewAll();
                    },
                    error: function(xhr, status, error){
                        alert("An error occurred while updating car: " + status + " " + error);
                    }
                });
            }

            function deleteCarAjax(id){
                $.ajax({
                    url: "http://127.0.0.1:5000/cars/" + encodeURIComponent(id),
                    method: "DELETE",
                    dataType: "JSON",
                    success: function(result){
                        $("#carTable tbody").find('tr').filter(function() {
                            return $(this).data("id") === id;
                        }).remove();
                    },
                    error: function(xhr, status, error){
                        alert("An error occurred while deleting car: " + status + " " + error);
                    }
                });
            }
        });
    </script>
</body>
</html>
